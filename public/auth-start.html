<!--This file is used during the Teams authentication flow to assist with retrieval of the access token.-->
<!--If you're not familiar with this, do not alter or remove this file from your project.-->
<html>
  <head>
    <title>Login Start Page</title>
    <meta charset="utf-8" />
  </head>

  <body>
    <script
      src="https://res.cdn.office.net/teams-js/2.7.1/js/MicrosoftTeams.min.js"
      integrity="sha384-4Gy2G+qxzDVdrdemcVqKVQvaSK1Ghg3x6xcsaMLPc/pw7KPtiogHGM97LTWF2PWg"
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript">
      // THIS CONSTANT NEEDS TO BE CHANGED ON CHANGING THE CORRERSPONDING THE AUZURE APP REGISTRATION SETTINGS
      const TEAMS_CONFIG = {
        CLIENT_ID: "7674fd74-8f6a-4ddd-870f-396349aa44d6",
      };

      const MS_TENANT_ID = "52bc7e22-6631-4c88-9c4f-9c115c186148";
      const MS_AUTH_CODE_SCOPE =
        "ChatMember.Read GroupMember.Read.All User.ReadBasic.All offline_access";
      const MS_AUTH_CODE_URL = `https://login.microsoftonline.com/${MS_TENANT_ID}/oauth2/v2.0/authorize`;

      const MS_AUTH_CODE_REDIRECT_URI =
        window.location.origin +
        window.location.pathname.slice(0, -16) +
        `/auth-end.html?clientId=${TEAMS_CONFIG.CLIENT_ID}`;

      const getMSCodeVerifierKey = () => {
        return `${TEAMS_CONFIG.CLIENT_ID}:MS-code-verifier`;
      };

      microsoftTeams.app.initialize().then(async () => {
        const randomString = (length, chars) => {
          var result = "";
          for (var i = length; i > 0; --i)
            result += chars[Math.floor(Math.random() * chars.length)];
          return result;
        };
        const STATE = randomString(
          15,
          "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
        );
        const CODE_VERIFIER = randomString(
          100,
          "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-._~"
        );
        localStorage.setItem(getMSCodeVerifierKey(), CODE_VERIFIER);
        window.location.assign(
          `${MS_AUTH_CODE_URL}?&client_id=${
            TEAMS_CONFIG.CLIENT_ID
          }&redirect_uri=${encodeURIComponent(
            MS_AUTH_CODE_REDIRECT_URI
          )}&response_mode=query&scope=${encodeURIComponent(
            MS_AUTH_CODE_SCOPE
          )}&state=${STATE}&response_type=code&code_challenge=${CODE_VERIFIER}&code_challenge_method=plain`
        );
      });
    </script>
  </body>
</html>
