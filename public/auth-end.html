<!--This file is used during the Teams authentication flow to assist with retrieval of the access token.-->
<!--If you're not familiar with this, do not alter or remove this file from your project.-->
<html>
  <head>
    <title>Login End Page</title>
    <meta charset="utf-8" />
  </head>

  <body>
    <script
      src="https://res.cdn.office.net/teams-js/2.7.1/js/MicrosoftTeams.min.js"
      integrity="sha384-4Gy2G+qxzDVdrdemcVqKVQvaSK1Ghg3x6xcsaMLPc/pw7KPtiogHGM97LTWF2PWg"
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript">
      // THESE TWO CONSTANTS NEED TO BE CHANGED ON CHANGING THE CORRERSPONDING SETTINGS OF AZURE APP REGISTRATION
      const TEAMS_CONFIG = {
        CLIENT_ID: "7674fd74-8f6a-4ddd-870f-396349aa44d6",
      };
      const MS_TENANT_ID = "52bc7e22-6631-4c88-9c4f-9c115c186148";
      const MS_ACCESS_TOKEN_URL = `https://login.microsoftonline.com/${MS_TENANT_ID}/oauth2/v2.0/token`;

      const MS_AUTH_CODE_REDIRECT_URI = window.location.href;

      const getMSCodeVerifierKey = () => {
        return `${TEAMS_CONFIG.CLIENT_ID}:MS-code-verifier`;
      };

      microsoftTeams.app.initialize().then(async () => {
        const parameters = new URLSearchParams(window.location.href);
        if (!parameters.has("code")) {
          microsoftTeams.authentication.notifyFailure(
            "Got no authorization code"
          );
        } else {
          const code = parameters.get("code");
          const CODE_VERIFIER = localStorage.getItem(getMSCodeVerifierKey());
          localStorage.removeItem(getMSCodeVerifierKey());
          await fetch(MS_ACCESS_TOKEN_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              client_id: TEAMS_CONFIG.CLIENT_ID,
              code: code,
              redirect_uri: MS_AUTH_CODE_REDIRECT_URI,
              grant_type: "authorization_code",
              code_verifier: CODE_VERIFIER,
            }),
          })
            .then((response) => response.json())
            .then((response) => {
              console.log(
                "Received tokens in MS authentication popup: ",
                response
              );
              microsoftTeams.authentication.notifySuccess(
                JSON.stringify(response)
              );
            })
            .catch((error) => {
              microsoftTeams.authentication.notifyFailure(
                JSON.stringify({ error })
              );
            });
        }
      });
    </script>
  </body>
</html>
